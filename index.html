<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App</title>
  <style>
    /* Modernized CSS with variables, better layout, shadows, transitions */
    :root {
      --bg-primary: #36393f; /* Modern dark gray for Discord-like feel */
      --bg-secondary: #2f3136;
      --accent: #7289da; /* Modern purple-blue */
      --accent-hover: #677bc4;
      --text-primary: #dcddde;
      --text-secondary: #8e9297;
      --border: #202225;
      --shadow: rgba(0, 0, 0, 0.2);
    }

    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f6f6f7;
      --accent: #5865f2;
      --accent-hover: #4752c4;
      --text-primary: #060607;
      --text-secondary: #4f5660;
      --border: #dbdde1;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    .flex {
      display: flex;
    }

    .flex-col {
      flex-direction: column;
    }

    .h-screen {
      height: 100vh;
    }

    .h-full {
      height: 100%;
    }

    .w-72 {
      width: 18rem; /* Wider sidebar for modern look */
    }

    .p-4 {
      padding: 1rem;
    }

    .border-r {
      border-right: 1px solid var(--border);
    }

    .flex-1 {
      flex: 1;
    }

    .overflow-y-auto {
      overflow-y: auto;
    }

    .cursor-pointer {
      cursor: pointer;
    }

    button {
      background-color: var(--accent);
      color: #ffffff;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: var(--accent-hover);
    }

    input {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 0.5rem;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    li:hover {
      background-color: var(--bg-secondary);
    }

    /* Header for user and settings */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 1rem;
      background-color: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    .user-button {
      background-color: var(--accent);
      color: #ffffff;
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-weight: bold;
    }

    .settings-icon {
      font-size: 1.2rem;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .settings-icon:hover {
      color: var(--text-primary);
    }

    /* Group list with icons */
    .group-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .group-icons {
      display: flex;
      gap: 0.5rem;
    }

    .icon {
      font-size: 1rem;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .icon:hover {
      color: var(--text-primary);
    }

    /* Add group button */
    .add-group {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent);
      cursor: pointer;
      text-align: center;
      margin-bottom: 1rem;
    }

    .add-group:hover {
      color: var(--accent-hover);
    }

    /* Chat messages */
    .message {
      background-color: var(--bg-secondary);
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      box-shadow: 0 1px 2px var(--shadow);
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
    }
  </style>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/socket.io-client/dist/socket.io.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const socket = io('http://localhost:5000', {
      auth: { token: localStorage.getItem('token') }
    });

    const App = () => {
      const [theme, setTheme] = useState(localStorage.getItem('theme') || 'dark');
      const [groups, setGroups] = useState([]);
      const [selectedChannel, setSelectedChannel] = useState(null);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [peers, setPeers] = useState({});
      const localAudioRef = useRef(null);
      const remoteAudioRefs = useRef({});
      const username = '%jmenouzivatele%'; // Placeholder for username

      useEffect(() => {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
      }, [theme]);

      useEffect(() => {
        // Fetch groups (assume API returns groups with channels)
        axios.get('http://localhost:5000/api/groups').then(res => setGroups(res.data));
      }, []);

      useEffect(() => {
        if (selectedChannel && selectedChannel.type === 'text') {
          axios.get(`http://localhost:5000/api/channels/${selectedChannel._id}/messages`).then(res => setMessages(res.data));
          socket.emit('joinChannel', selectedChannel._id);
          socket.on('receiveMessage', msg => setMessages(prev => [...prev, msg]));
        } else if (selectedChannel && selectedChannel.type === 'voice') {
          navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
              localAudioRef.current = new Audio();
              localAudioRef.current.srcObject = stream;
              localAudioRef.current.muted = true;
              socket.emit('joinVoiceChannel', selectedChannel._id);

              socket.on('peerJoined', ({ peerId }) => {
                createPeerConnection(peerId, stream, true);
              });

              socket.on('offer', async ({ offer, fromPeerId }) => {
                const pc = createPeerConnection(fromPeerId, stream, false);
                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit('answer', { answer: pc.localDescription, toPeerId: fromPeerId });
              });

              socket.on('answer', ({ answer, fromPeerId }) => {
                const pc = peers[fromPeerId];
                if (pc) pc.setRemoteDescription(new RTCSessionDescription(answer));
              });

              socket.on('iceCandidate', ({ candidate, fromPeerId }) => {
                const pc = peers[fromPeerId];
                if (pc) pc.addIceCandidate(new RTCIceCandidate(candidate));
              });

              socket.on('peerLeft', ({ peerId }) => {
                const pc = peers[peerId];
                if (pc) pc.close();
                setPeers(prev => { const newPeers = { ...prev }; delete newPeers[peerId]; return newPeers; });
                if (remoteAudioRefs.current[peerId]) {
                  remoteAudioRefs.current[peerId].pause();
                  delete remoteAudioRefs.current[peerId];
                }
              });
            })
            .catch(err => console.error('Media error:', err));
        }

        return () => {
          if (selectedChannel) {
            if (selectedChannel.type === 'voice') socket.emit('leaveVoiceChannel', selectedChannel._id);
            socket.off('receiveMessage');
            socket.off('peerJoined');
            socket.off('offer');
            socket.off('answer');
            socket.off('iceCandidate');
            socket.off('peerLeft');
          }
        };
      }, [selectedChannel]);

      const createPeerConnection = (peerId, stream, isCaller) => {
        const pc = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });

        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        pc.ontrack = (event) => {
          if (!remoteAudioRefs.current[peerId]) {
            const audio = new Audio();
            audio.srcObject = event.streams[0];
            audio.autoplay = true;
            remoteAudioRefs.current[peerId] = audio;
          }
        };

        pc.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit('iceCandidate', { candidate: event.candidate, toPeerId: peerId });
          }
        };

        setPeers(prev => ({ ...prev, [peerId]: pc }));

        if (isCaller) {
          pc.createOffer().then(offer => {
            pc.setLocalDescription(offer);
            socket.emit('offer', { offer, toPeerId: peerId, channelId: selectedChannel._id });
          });
        }

        return pc;
      };

      const sendMessage = () => {
        if (input && selectedChannel.type === 'text') {
          socket.emit('sendMessage', { channelId: selectedChannel._id, content: input });
          setInput('');
        }
      };

      const createGroup = () => {
        const name = prompt('Group name?');
        if (name) {
          axios.post('http://localhost:5000/api/groups', { name }).then(res => {
            setGroups(prev => [...prev, res.data]);
          });
        }
      };

      return (
        <div className="flex h-screen">
          {/* Sidebar */}
          <div className="w-72 flex flex-col" style={{ backgroundColor: var(--bg-secondary) }}>
            <div className="header">
              <div className="user-button">{username}</div>
              <div className="settings-icon" onClick={() => alert('User Settings')}>‚öôÔ∏è</div>
            </div>
            <div className="p-4 flex-1 overflow-y-auto">
              <div className="add-group" onClick={createGroup}>+</div>
              <ul>
                {groups.map(group => (
                  <li key={group._id} className="group-item">
                    <span className="cursor-pointer" onClick={() => alert(`Open group: ${group.name}`)}>{group.name}</span>
                    <div className="group-icons">
                      <span className="icon" title="Call" onClick={() => alert(`Call in ${group.name}`)}>üìû</span>
                      <span className="icon" title="Chat" onClick={() => alert(`Chat in ${group.name}`)}>üí¨</span>
                      <span className="icon" title="Messages" onClick={() => alert(`Messages in ${group.name}`)}>‚úâÔ∏è</span>
                      <span className="icon" title="Group Settings" onClick={() => alert(`Settings for ${group.name}`)}>‚öôÔ∏è</span>
                    </div>
                  </li>
                ))}
              </ul>
              <ul>
                {selectedChannel && groups.find(g => g._id === selectedChannel.groupId)?.channels?.map(channel => (
                  <li key={channel._id} onClick={() => setSelectedChannel(channel)} className="cursor-pointer">
                    {channel.name} ({channel.type})
                  </li>
                ))}
              </ul>
            </div>
            <div className="p-4 border-t" style={{ borderColor: var(--border) }}>
              <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} style={{ width: '100%' }}>Toggle Theme</button>
            </div>
          </div>

          {/* Main Chat/Voice */}
          <div className="flex-1 flex flex-col">
            <div className="header">
              <h2>{selectedChannel ? selectedChannel.name : 'Select a channel'}</h2>
              {selectedChannel && <div className="settings-icon" onClick={() => alert('Channel Settings')}>‚öôÔ∏è</div>}
            </div>
            <div className="flex-1 p-4 overflow-y-auto">
              {selectedChannel ? (
                selectedChannel.type === 'text' ? (
                  messages.map((msg, idx) => <div key={idx} className="message">{msg.content}</div>)
                ) : (
                  <div>
                    <h2>Voice Channel: {selectedChannel.name}</h2>
                    <p>Connected peers: {Object.keys(peers).length}</p>
                  </div>
                )
              ) : (
                <p>Select a channel</p>
              )}
            </div>
            {selectedChannel && selectedChannel.type === 'text' && (
              <div className="p-4 border-t" style={{ borderColor: var(--border), backgroundColor: var(--bg-secondary) }}>
                <div className="flex">
                  <input value={input} onChange={e => setInput(e.target.value)} style={{ flex: 1, marginRight: '0.5rem' }} />
                  <button onClick={sendMessage}>Send</button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
